<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計時器 - 實用小工具集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap");
        body { font-family: "Inter", sans-serif; }
        .font-mono { font-family: "JetBrains Mono", monospace; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        .mode-active {
            color: black;
            border-bottom: 2px solid black;
        }
        
        .mode-inactive {
            color: #9ca3af;
            border-bottom: 2px solid transparent;
        }
        
        .mode-inactive:hover {
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-white text-gray-900 min-h-screen antialiased flex flex-col">
    <nav class="border-b border-gray-100 flex-none">
        <div class="max-w-7xl mx-auto px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-2">
                    <a href="index.html" class="w-8 h-8 bg-black rounded-lg flex items-center justify-center hover:opacity-80 transition-opacity">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    </a>
                    <span class="text-xl font-bold tracking-tight">計時器</span>
                </div>
                <button onclick="shareTimer()" id="shareBtn" class="text-sm font-semibold border border-gray-200 px-4 py-2 rounded-lg hover:border-black hover:bg-black hover:text-white transition-all">
                    複製連結
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center justify-center p-6 w-full max-w-7xl mx-auto">
        
        <!-- Mode Switcher -->
        <div class="flex gap-8 mb-12 text-sm font-bold tracking-widest uppercase" id="modeSwitcher">
            <button onclick="switchMode('timer')" id="tab-timer" class="mode-active pb-2 transition-colors">計時器</button>
            <button onclick="switchMode('stopwatch')" id="tab-stopwatch" class="mode-inactive pb-2 transition-colors">碼表</button>
        </div>

        <!-- Timer Display Area -->
        <div class="relative w-full text-center">
             <!-- Timer Display -->
             <div id="timeDisplay" class="text-[12vw] leading-none font-bold font-mono tracking-tighter tabular-nums select-none mb-8">
                00:05:00
            </div>
            
            <!-- Stopwatch Display (Hidden by default) -->
             <div id="swDisplay" class="text-[12vw] leading-none font-bold font-mono tracking-tighter tabular-nums select-none mb-8 hidden">
                00:00.00
            </div>
            
            <!-- Progress Line (Timer Only) -->
            <div id="progressContainer" class="h-1 w-full bg-gray-100 rounded-full overflow-hidden max-w-4xl mx-auto mb-12">
                <div id="progress" class="h-full bg-black transition-all duration-300" style="width: 100%"></div>
            </div>

            <!-- Controls -->
            <div class="flex items-center justify-center gap-6">
                <!-- Main Action Button -->
                <button id="mainBtn" onclick="toggleAction()"
                    class="w-24 h-24 rounded-full bg-black text-white flex items-center justify-center hover:scale-105 transition-transform">
                    <svg id="playIcon" class="w-10 h-10 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pauseIcon" class="w-10 h-10 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                
                <!-- Reset Button -->
                <button onclick="resetAction()"
                    class="w-16 h-16 rounded-full border-2 border-gray-200 text-gray-500 flex items-center justify-center hover:border-red-500 hover:text-red-500 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                </button>
                
                <!-- Fullscreen Button -->
                <button onclick="toggleFullscreen()"
                    class="w-16 h-16 rounded-full border-2 border-gray-200 text-gray-500 flex items-center justify-center hover:border-black hover:text-black transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                </button>
            </div>
        </div>

        <!-- Timer Inputs / Settings -->
        <div id="settings-panel" class="mt-20 w-full max-w-2xl mx-auto transition-opacity duration-300">
            <div class="grid grid-cols-3 gap-8">
                <div class="flex flex-col items-center">
                    <input type="number" id="hours" min="0" max="99" value="0"
                        class="text-4xl font-bold font-mono text-center w-full bg-transparent border-b-2 border-gray-100 focus:border-black outline-none transition-colors py-2"
                        onchange="updateTimeFromInput()">
                    <span class="text-xs font-bold text-gray-400 mt-2 uppercase tracking-widest">小時</span>
                </div>
                <div class="flex flex-col items-center">
                    <input type="number" id="minutes" min="0" max="59" value="5"
                        class="text-4xl font-bold font-mono text-center w-full bg-transparent border-b-2 border-gray-100 focus:border-black outline-none transition-colors py-2"
                        onchange="updateTimeFromInput()">
                    <span class="text-xs font-bold text-gray-400 mt-2 uppercase tracking-widest">分鐘</span>
                </div>
                <div class="flex flex-col items-center">
                    <input type="number" id="seconds" min="0" max="59" value="0"
                        class="text-4xl font-bold font-mono text-center w-full bg-transparent border-b-2 border-gray-100 focus:border-black outline-none transition-colors py-2"
                        onchange="updateTimeFromInput()">
                    <span class="text-xs font-bold text-gray-400 mt-2 uppercase tracking-widest">秒</span>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3 mt-8">
                <button onclick="setQuickTime(1)" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium hover:border-black hover:bg-black hover:text-white transition-all">1m</button>
                <button onclick="setQuickTime(5)" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium hover:border-black hover:bg-black hover:text-white transition-all">5m</button>
                <button onclick="setQuickTime(10)" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium hover:border-black hover:bg-black hover:text-white transition-all">10m</button>
                <button onclick="setQuickTime(25)" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium hover:border-black hover:bg-black hover:text-white transition-all">25m</button>
                <button onclick="setQuickTime(30)" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium hover:border-black hover:bg-black hover:text-white transition-all">30m</button>
                <button onclick="setQuickTime(60)" class="px-4 py-2 rounded-full border border-gray-200 text-sm font-medium hover:border-black hover:bg-black hover:text-white transition-all">1h</button>
            </div>
        </div>
    </main>

    <!-- Fullscreen Controls Overlay (Only visible in fullscreen) -->
    <div id="fullscreen-controls" class="hidden fixed top-0 right-0 p-8 z-50">
        <button onclick="document.exitFullscreen()" class="text-white/50 hover:text-white transition-colors">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>

    <script>
        let currentMode = "timer"; // "timer" or "stopwatch"
        
        // --- Timer State ---
        let timerInterval;
        let totalSeconds = 300;
        let remainingSeconds = 300;
        let isTimerRunning = false;
        let targetTimestamp = null;

        // --- Stopwatch State ---
        let swInterval;
        let swStartTime = 0;
        let swElapsedBeforePause = 0;
        let isSwRunning = false;

        // --- Elements ---
        const timeDisplay = document.getElementById("timeDisplay");
        const swDisplay = document.getElementById("swDisplay");
        const progress = document.getElementById("progress");
        const progressContainer = document.getElementById("progressContainer"); 
        const playIcon = document.getElementById("playIcon");
        const pauseIcon = document.getElementById("pauseIcon");
        const settingsPanel = document.getElementById("settings-panel");
        const shareBtn = document.getElementById("shareBtn");
        const modeSwitcher = document.getElementById("modeSwitcher");
        const inputs = {
            h: document.getElementById("hours"),
            m: document.getElementById("minutes"),
            s: document.getElementById("seconds")
        };

        // --- Mode Switching ---
        function switchMode(mode) {
            currentMode = mode;
            
            // UI Toggle
            document.getElementById("tab-timer").className = mode === "timer" ? "mode-active pb-2 transition-colors" : "mode-inactive pb-2 transition-colors";
            document.getElementById("tab-stopwatch").className = mode === "stopwatch" ? "mode-active pb-2 transition-colors" : "mode-inactive pb-2 transition-colors";

            if (mode === "timer") {
                timeDisplay.classList.remove("hidden");
                swDisplay.classList.add("hidden");
                progressContainer.classList.remove("hidden");
                settingsPanel.classList.remove("hidden");
                updateTimerUIState();
            } else {
                timeDisplay.classList.add("hidden");
                swDisplay.classList.remove("hidden");
                progressContainer.classList.add("hidden");
                settingsPanel.classList.add("hidden");
                updateStopwatchUIState();
            }
        }

        // --- Main Actions (Mapped) ---
        function toggleAction() {
            if (currentMode === "timer") toggleTimer();
            else toggleStopwatch();
        }

        function resetAction() {
            if (currentMode === "timer") resetTimer();
            else resetStopwatch();
        }

        function updatePlayPauseIcon(isPlaying) {
            if(isPlaying) {
                playIcon.classList.add("hidden");
                pauseIcon.classList.remove("hidden");
            } else {
                playIcon.classList.remove("hidden");
                pauseIcon.classList.add("hidden");
            }
        }

        // ================= TIMER LOGIC =================
        function formatTime(totalSecs) {
            const h = Math.floor(totalSecs / 3600);
            const m = Math.floor((totalSecs % 3600) / 60);
            const s = totalSecs % 60;
            return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        }

        function updateTimerDisplay() {
            timeDisplay.textContent = formatTime(remainingSeconds);
            const pct = totalSeconds > 0 ? (remainingSeconds / totalSeconds) * 100 : 0;
            progress.style.width = `${pct}%`;
            
            if (!isTimerRunning && !targetTimestamp) {
                inputs.h.value = Math.floor(remainingSeconds / 3600);
                inputs.m.value = Math.floor((remainingSeconds % 3600) / 60);
                inputs.s.value = remainingSeconds % 60;
            }
        }

        function toggleTimer() {
            if (isTimerRunning) pauseTimer();
            else startTimer();
        }

        function startTimer() {
            if (remainingSeconds <= 0) return;
            isTimerRunning = true;
            settingsPanel.classList.add("opacity-50", "pointer-events-none");
            updatePlayPauseIcon(true);
            
            if (!targetTimestamp) {
                targetTimestamp = Date.now() + (remainingSeconds * 1000);
            }

            // High frequency update for smoother visual feels, but logic is per second
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((targetTimestamp - now) / 1000);
                
                if (diff <= 0) {
                    remainingSeconds = 0;
                    finishTimer();
                } else {
                    remainingSeconds = diff;
                }
                updateTimerDisplay();
            }, 100);
        }

        function pauseTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            settingsPanel.classList.remove("opacity-50", "pointer-events-none");
            updatePlayPauseIcon(false);
            targetTimestamp = null;
        }

        function resetTimer() {
            pauseTimer();
            updateTimeFromInput();
        }

        function finishTimer() {
            pauseTimer();
            remainingSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimeFromInput() {
            const h = parseInt(inputs.h.value) || 0;
            const m = parseInt(inputs.m.value) || 0;
            const s = parseInt(inputs.s.value) || 0;
            totalSeconds = (h * 3600) + (m * 60) + s;
            remainingSeconds = totalSeconds;
            updateTimerDisplay();
        }

        function setQuickTime(minutes) {
            inputs.h.value = 0;
            inputs.m.value = minutes;
            inputs.s.value = 0;
            updateTimeFromInput();
        }

        function updateTimerUIState() {
            updatePlayPauseIcon(isTimerRunning);
            updateTimerDisplay();
        }


        // ================= STOPWATCH LOGIC =================
        function formatStopwatch(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            const centis = Math.floor((ms % 1000) / 10);
            return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}.${centis.toString().padStart(2, "0")}`;
        }

        function updateStopwatchDisplay(ms) {
            swDisplay.textContent = formatStopwatch(ms);
        }

        function toggleStopwatch() {
            if (isSwRunning) pauseStopwatch();
            else startStopwatch();
        }

        function startStopwatch() {
            isSwRunning = true;
            // Only recalculate start time if not already set (e.g., from URL params)
            if (swElapsedBeforePause > 0 && !swStartTime) {
                swStartTime = Date.now() - swElapsedBeforePause;
            } else if (!swStartTime) {
                swStartTime = Date.now();
            }
            updatePlayPauseIcon(true);

            swInterval = requestAnimationFrame(swLoop);
        }

        function swLoop() {
            if(!isSwRunning) return;
            const now = Date.now();
            const currentElapsed = now - swStartTime;
            updateStopwatchDisplay(currentElapsed);
            swInterval = requestAnimationFrame(swLoop);
        }

        function pauseStopwatch() {
            isSwRunning = false;
            cancelAnimationFrame(swInterval);
            swElapsedBeforePause = Date.now() - swStartTime;
            updatePlayPauseIcon(false);
        }

        function resetStopwatch() {
            pauseStopwatch();
            swElapsedBeforePause = 0;
            updateStopwatchDisplay(0);
        }

         function updateStopwatchUIState() {
            updatePlayPauseIcon(isSwRunning);
            // Display current state
            if(isSwRunning) {
                 const currentElapsed = Date.now() - swStartTime;
                 updateStopwatchDisplay(currentElapsed);
            } else {
                 updateStopwatchDisplay(swElapsedBeforePause);
            }
        }


        // ================= GLOBAL =================
        function toggleFullscreen() {
            const doc = document.documentElement;
            if (!document.fullscreenElement) {
                doc.requestFullscreen().catch(err => alert(err.message));
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener("fullscreenchange", () => {
             const body = document.body;
             const fsControls = document.getElementById("fullscreen-controls");
             const nav = document.querySelector("nav");
             // modeSwitcher is already defined above

             if (document.fullscreenElement) {
                 body.classList.add("bg-black", "text-white");
                 body.classList.remove("bg-white", "text-gray-900");
                 fsControls.classList.remove("hidden");
                 nav.classList.add("hidden");
                 modeSwitcher.classList.add("hidden");
             } else {
                 body.classList.remove("bg-black", "text-white");
                 body.classList.add("bg-white", "text-gray-900");
                 fsControls.classList.add("hidden");
                 nav.classList.remove("hidden");
                 modeSwitcher.classList.remove("hidden");
             }
        });

        function shareTimer() {
            const url = new URL(window.location.href);
            if (currentMode === "timer") {
                 if (isTimerRunning && targetTimestamp) {
                    url.searchParams.set("target", targetTimestamp);
                    url.searchParams.delete("duration");
                    url.searchParams.delete("mode");
                    url.searchParams.delete("swstart");
                } else {
                    url.searchParams.set("duration", totalSeconds);
                    url.searchParams.delete("target");
                    url.searchParams.delete("mode");
                    url.searchParams.delete("swstart");
                }
            } else {
                // Stopwatch mode - share synchronized start time
                url.searchParams.delete("target");
                url.searchParams.delete("duration");
                url.searchParams.set("mode", "stopwatch");
                // Always share the actual start time (whether running or paused)
                // If paused, calculate what the start time would be to show current elapsed
                const actualStartTime = isSwRunning ? swStartTime : (Date.now() - swElapsedBeforePause);
                url.searchParams.set("swstart", actualStartTime);
            }

            navigator.clipboard.writeText(url.toString()).then(() => {
                const btn = document.getElementById("shareBtn");
                const oldText = btn.textContent;
                btn.textContent = "已複製！";
                btn.classList.add("bg-green-600", "text-white", "border-green-600");
                setTimeout(() => {
                    btn.textContent = oldText;
                    btn.classList.remove("bg-green-600", "text-white", "border-green-600");
                }, 2000);
            });
        }

        function checkParams() {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get("mode");
            const target = params.get("target");
            const duration = params.get("duration");
            const swstart = params.get("swstart");

            if (mode === "stopwatch" && swstart) {
                switchMode("stopwatch");
                const startTime = parseInt(swstart);
                swStartTime = startTime;
                swElapsedBeforePause = 0;
                // Auto-start the stopwatch to sync with others
                startStopwatch();
            } else if (target) {
                switchMode("timer");
                const now = Date.now();
                const end = parseInt(target);
                const diff = Math.ceil((end - now) / 1000);

                if (diff > 0) {
                    remainingSeconds = diff;
                    totalSeconds = Math.max(totalSeconds, diff);
                    targetTimestamp = end;
                    startTimer();
                }
            } else if (duration) {
                switchMode("timer");
                const secs = parseInt(duration);
                inputs.h.value = Math.floor(secs / 3600);
                inputs.m.value = Math.floor((secs % 3600) / 60);
                inputs.s.value = secs % 60;
                updateTimeFromInput();
            }
        }

        // Init
        checkParams();
        updateTimerDisplay(); // Initial draw
    </script>
</body>
</html>